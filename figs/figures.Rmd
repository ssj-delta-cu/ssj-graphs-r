---
title: "SSJ-DELTA-CU report figures"
output:
  html_document: default
---

# About
This Rmarkdown document (`figs/figures.Rmd`) is used for generating the figures for the SSJ-Delta-CU report. The chunks can be run individually but make sure to run the `setup` and `project_settings` chunk first to ensure that all the libraries and data are loaded. 

```{r "setup", include=FALSE}
# knitr settings
require("knitr")
opts_knit$set(root.dir = "..") # set working directory to be ssj-graph-r directory
knitr::opts_chunk$set(error = TRUE)

```

```{r project_settings, echo=FALSE, include=FALSE}
# source scripts for plots and helper functions
source("scripts/helper_functions.R") # load all the helper functions
source("scripts/figures.R") # load all the functions that generate the graphs
source("scripts/tables.R") # load in the table file to calc acre-ft totals to export to csv.

# data sources
dsa_legal_data <- readRDS("data/dsa_legal/dsa_legal.rds")
dsa_etrf <- readRDS("data/dsa_etrf/dsa_etrf.rds")
delta_regions <- readRDS("data/delta_regions/delta_regions.rds")
fieldstations_data <- readRDS("data/fieldstations/wy2016/fieldstations_wy2016.rds")
fieldstations_data_2015 <- readRDS("data/fieldstations/wy2015/fieldstations_wy2015.rds")
subregions <- readRDS("data/subregions/subregions.rds")
eto <- readRDS('data/eto/eto.rds')

# vector containing the water years
water_years <- c(2015, 2016)

# footer 
footer <- paste('Updated ', Sys.Date())

```

# Delta Level Analysis

## Total Acre-feet for Legal Delta and Delta Service Area

```{r TAF_WY, echo=FALSE, fig.width = 8, fig.height = 4}

# loop through both water years 
for(y in 1:length(water_years)){ 
  
  wy <- water_years[y]
  
  # create the sum_TAF plot for the selected water year
  p <- sum_TAFxModel_dsa_legal(dsa_legal_data, wy)
  
  # add footer (commented out to avoid overwriting the existing caption)
  #p <- p + labs(caption=footer)
  
  # let's also generate a table with this data.
  t <- table_taf_wy_regions(dsa_legal_data, wy)
  
  # add plot and table to rmarkdown output
  plot(p)
  print(t)
  }

```

## Lineplot Monthly ET by Model for a single crop for two water years

```{r lineplot_ET, echo=FALSE, fig.width = 7, fig.height = 4}

# list of crops to generate
crops_2_gen <- c("Alfalfa", "Almonds", "Corn", "Pasture", "Potatoes", "Rice", "Tomatoes", "Vineyards")

# loop through the crops
for(i in 1:length(crops_2_gen)){
  
  # get the id from the crop name
  cropid <- lookup_cropid(crops_2_gen[i])
  
  # generate plot for the crop for the delta service area
  p <- line_ETxMonths_2wateryears(dsa_legal_data, cropid,  "dsa")
  
  # add footer with the date
  p <- p + labs(caption=footer)
  
  # add plot to rmarkdown output
  plot(p)
}
```

## Cumulative Lineplot Monthly ET by Model for a single crop for two water years

```{r lineplot_cumET, echo=FALSE, fig.width = 7, fig.height = 4}

# list of crops to generate
crops_2_gen <- c("Alfalfa", "Almonds", "Corn", "Pasture", "Potatoes", "Rice", "Tomatoes", "Vineyards")

# loop through the crops
for(i in 1:length(crops_2_gen)){

  # get the id from the crop name
  cropid <- lookup_cropid(crops_2_gen[i])
  
  #plot
  p <- line_ETxMonths_cumulative(dsa_legal_data, cropid,  "dsa")
  
  # add footer
  p <- p + labs(caption=footer)
  
  plot(p)
}
```


## Boxplot whisker_ETxModel_per_crop_month

```{r whisker_ETxModel_per_crop_month_2yrs, echo=FALSE, fig.width = 7, fig.height = 4}

# list of crops to generate
crops_2_gen <- c("Alfalfa", "Almonds", "Corn", "Pasture", "Potatoes", "Rice", "Tomatoes", "Vineyards")

# list of the months in the water year to generate (Oct-> sept)
month_2_gen <- c('JUL') #month_list()


# loop through the crops
for(i in 1:length(crops_2_gen)){

  # get the id from the crop name
  cropid <- lookup_cropid(crops_2_gen[i])

  # loop through the months
  for(m in 1:length(month_2_gen)){
    month <- month_2_gen[m]

    #plot
    p <- whisker_ETxModel_per_crop_month_2yrs(dsa_legal_data, 'dsa', month, cropid)
    
    # add footer
    p <- p + labs(caption=footer)

    # add plot to rmarkdown output
    plot(p)
    
  }
}


```


## Boxplot whisker_ETxMonths_per_crop_method

```{r whisker_ETxMonths_per_crop_method, echo=FALSE, fig.width = 7, fig.height = 4}

# list of crops to generate
crops_2_gen <- c("Alfalfa", "Almonds", "Corn", "Pasture", "Potatoes", "Rice", "Tomatoes", "Vineyards")

# list of methods to use for the plots
methods_2_gen <- methods_names

# loop through all crops types
for(i in 1:length(crops_2_gen)){

  # get the id from the crop name
  cropid <- lookup_cropid(crops_2_gen[i])
  
  # loop through the months
  for(m in 1:length(methods_2_gen)){
    mod <- methods_2_gen[m]
    
    # plot
    p <- whisker_ETxMonths_per_crop_method_2yrs(dsa_legal_data, 'dsa', mod, cropid)
    
    # add footer
    p <- p + labs(caption=footer)

    # add plot to rmarkdown output
    plot(p)
  }
}

```


## Grid coefficient variation

```{r coefficient_variation_grid, echo=FALSE, fig.width = 6, fig.height = 5}
# coeffient of variation grid

# loop through both water years and save the figure
for(y in 1:length(water_years)){
  wy <- water_years[y]
  
  p <- coefficient_variation_grid(dsa_legal_data, wy)
  
  # add footer
  p <- p + labs(caption=footer)

  # add plot to rmarkdown output
  plot(p)
}

```

## Grid absolute variation

```{r absolute_variation_grid, echo=FALSE, fig.width = 6, fig.height = 5}
# absolute variation grid

# loop through both water years and save the figure
for(y in 1:length(water_years)){
  wy <- water_years[y]
  
  p <- absolute_variation_grid(dsa_legal_data, wy)
  
  # add footer
  p <- p + labs(caption=footer)

  # add plot to rmarkdown output
  plot(p)
}

```

## Percent Total by the top crop types

Note: this doesn't include wet herb or semi-ag landuse classes.


```{r landuse_percent, echo=FALSE, fig.width = 9, fig.height = 4}

# filter out wet herb and landuse
dsa_legal_data_wo_wetsemi <- dsa_legal_data %>% filter(!level_2 %in% c(913, 2008))

for(y in 1:length(water_years)){
  wy <- water_years[y]
  p <- barchart_TAFxModel_PERCENT_wy_by_topcrops(dsa_legal_data_wo_wetsemi, wy, 'dsa')
  
  # add footer
  p <- p + labs(caption=footer)

  plot(p)
}

```

## Total Acre feet by month and crop type

Note: this doesn't include wet herb or semi-ag landuse classes.

The abberivation for the model groups are: "calsimetaw"="C", "detaw"="D", "disalexi"="D", "itrc"="I", "sims"="S", "ucdmetric"="M", "ucdpt"="P".

```{r crop breakdown_facet, echo=FALSE, fig.width = 11, fig.height = 4}

# filter out wet herb and landuse
dsa_legal_data_wo_wetsemi <- dsa_legal_data %>% filter(!level_2 %in% c(913, 2008))

for(y in 1:length(water_years)){
  wy <- water_years[y]
  p <- barchart_TAFxModel_sum_monthsfacet_by_topcrop(dsa_legal_data_wo_wetsemi, wy, 'dsa')
  
  # add footer
  p <- p + labs(caption=footer)

  plot(p)
}

```


# Subregion Level Analysis

## Selected Subset of Subregions TAF

```{r subregion_taf, echo=FALSE, fig.width = 7, fig.height = 4}

# loop through both water years 
for(y in 1:length(water_years)){
  wy <- water_years[y]
  
  p <- barchart_TAFxSubregions(subregions, wy)
  
  # add footer
  p <- p + labs(caption=footer)
  
  # add plot to rmarkdown output
  plot(p)
}

```

## Selected Subset of Subregions TAF Normalized by area

```{r subregion_taf_norm, echo=FALSE, fig.width = 7, fig.height = 4}

# loop through both water years and save the figure
for(y in 1:length(water_years)){
  wy <- water_years[y]
  
  p <- barchart_TAFxSubregions_normalizedAREA(subregions, wy)
  
  # add footer
  p <- p + labs(caption=footer)
  
  # add plot to rmarkdown output
  plot(p)
}

```

# Fieldstation Level Analysis

## Fieldstation vs Remote methods facet plot for Water Year 2016

```{r field_v_remote_facet, echo=FALSE, fig.width = 6, fig.height = 11}

# facet version
p <- lm_fieldxremote_facet_crop(fieldstations_data)

# add footer
p <- p + labs(caption=footer)


# add plot to rmarkdown output
plot(p)


```

## Fieldstation vs Remote methods facet plot for Water Year 2015
```{r field_v_remote_2015, echo=FALSE, fig.width = 7, fig.height = 5}

# remove D4
fieldstations_data_2015_filter <- fieldstations_data_2015 %>% filter(!Station %in% c("D4"))

# manually add asterisk to D3 and D4 in the dataframe
fieldstations_data_2015_filter$Station <- gsub('D3', 'D3*', fieldstations_data_2015_filter$Station)
fieldstations_data_2015_filter$Station <- gsub('D4', 'D4*', fieldstations_data_2015_filter$Station)

# ETo should be a horizontal line
eto_df <- fieldstations_data_2015_filter %>% filter(model=="eto") %>% select(Station, ET_mean) %>% rename(eto=ET_mean) %>% distinct(Station, eto)
field_wo_eto <- fieldstations_data_2015_filter %>% filter(!model=="eto")

# join the eto data with the model data
d <- left_join(field_wo_eto, eto_df, by=c("Station"))

# remove EC points
d <- d %>% filter(!measure_type=='EC')

p <- ggplot(d, aes(x=model, y=ET_mean, color=model))+
  geom_point(size=3.5)+
  geom_hline(aes(yintercept=field_mean_et), colour="#990000", linetype="dashed", lwd=1.5, alpha=0.5)+
  geom_hline(aes(yintercept=eto), colour="#000000", linetype="dashed", lwd=1.5, alpha=0.5)+
  geom_text(aes(x=6.35,y=eto), size=4, nudge_y = 0.2, colour="#000000", label='ETo')+
  geom_text(aes(x=6.35,y=field_mean_et, group=measure_type), size=4, nudge_y = 0.2, colour="#990000", label='ETa')+
  ylab("Model ET (mm/day)")+
  xlab("Bare Field Station")+
  scale_color_manual(values=model_palette, labels=methods_named_list)+
  theme_bw()+
  theme(panel.border = element_rect(colour = "black", fill="NA", size=1),
        panel.grid.major = element_blank(),
        plot.title = element_text(hjust = 0.5),
        panel.grid.minor = element_blank(),
        legend.position="bottom", # position of legend or none
        legend.direction="horizontal", # orientation of legend
        legend.title= element_blank(), # no title for legend
        legend.key.size = unit(0.5, "cm"),
        axis.text.y = element_text(size=12),
        axis.text.x = element_blank(),
        axis.title = element_text(size=14))+ 
        guides(colour = guide_legend(nrow = 2, keywidth = 3, keyheight = 1),
        fill = guide_legend(keywidth = 1, keyheight = 1),
        linetype=guide_legend(keywidth = 3, keyheight = 1))+
        facet_wrap(~Station, ncol=5, scales="free_x")+theme(strip.background = element_blank(),
        strip.placement = "outside", 
        strip.text.x = element_text(size = 16))

# add footer
p <- p + labs(caption=footer)

# add plot to rmarkdown output
plot(p)

```



## ETrF plots - using spatial cimis for all methods

```{r etrf, echo=FALSE, fig.width = 7, fig.height = 4}
# list of crops to generate
crops_2_gen <- c("Alfalfa", "Almonds", "Corn", "Pasture", "Potatoes", "Rice", "Tomatoes", "Vineyards")

# loop through the crops
for(c in crops_2_gen){
  p <- etrf(dsa_legal_data, c)

  # add footer
  p <- p + labs(caption=footer)
  
  # add plot to rmarkdown output
  plot(p)
}
```

## ETRF plots (pixel level calc in EE)

DETAW & DisAlexi provided seperate ETo. The rest of the methods use spatial cimis.

```{r etrf_ee, echo=FALSE, fig.width = 7, fig.height = 4}
# list of crops to generate
crops_2_gen <- c("Alfalfa", "Almonds", "Corn", "Pasture", "Potatoes", "Rice", "Tomatoes", "Vineyards")

# loop through the crops
for(c in crops_2_gen){
  p <- etrf2(dsa_etrf, c)

  # add footer
  p <- p + labs(caption=footer)
  
  # add plot to rmarkdown output
  plot(p)
}
```


# Calculations for numbers in the report

```{r}
# ET totals for non-ag classes 
# for numbers in text above table 3.

# summarize total acre-ft just using non-crops (ie include = "no")
af_noncrops <- dsa_legal_data %>% filter(include == "no", crop_acft > 0) %>%
    dplyr::group_by(model, region, wateryear) %>% 
    dplyr::summarise(sum_af=sum(crop_acft)) %>% filter(region == "dsa")

# remove sims since they don't account for water or native classes + remove eto data
af_noncrops_wo_sims <- af_noncrops %>% filter(!model %in% c("sims", "eto"))

# average of noncrop by year
af_noncrops_avg <- af_noncrops_wo_sims %>% group_by(wateryear) %>% summarize(mean=mean(sum_af))

avg_2015 <- af_noncrops_avg$mean[af_noncrops_avg$wateryear==2015]
avg_2016 <- af_noncrops_avg$mean[af_noncrops_avg$wateryear==2016]

# print results
print(paste("Not all methods are capable of estimating ET for other land uses (i.e. urban, open water, and vegetation), but available estimates for those excluded land classes averaged about", round(avg_2015/1000), "TAF in 2015 and increased to", round(avg_2016/1000) , "TAF in 2016"))

```

```{r}

# average evapotranspiration for september to january as percentage of total annual et

# text after coefficient of variation grids

# summarize total acre-ft just using crops (ie include = "yes")
af_annual <- dsa_legal_data %>% filter(include == "yes", crop_acft > 0) %>%
    dplyr::group_by(model, region, wateryear) %>% 
    dplyr::summarise(sum_af=sum(crop_acft)) %>% filter(region == "dsa")

af_annual_mean <- af_annual %>% group_by(wateryear) %>% summarize(total=mean(sum_af))


# Between selected months (Sept to Jan)
af_select <- dsa_legal_data %>% filter(include == "yes", crop_acft > 0) %>%
    filter(month %in% c("SEP", "OCT", "NOV", "DEC", "JAN"))%>%
    dplyr::group_by(model, region, wateryear) %>% 
    dplyr::summarise(sum_af=sum(crop_acft)) %>% filter(region == "dsa")

af_select_mean <- af_select %>% group_by(wateryear) %>% summarize(select=mean(sum_af))


# join annual and select together using water year
af_both <- merge(af_annual_mean, af_select_mean, by="wateryear") %>% mutate(percent=select/total*100)

# both wateryears are approx 22 or 23 % so let's just take the avearage
af_select_percent <- round(mean(af_both$percent), 1)

print(paste("We employed the coefficient of variation to calculate degree of discrepancy among models by crop are higher from September to January. Evapotranspiration estimates in these months represent about", af_select_percent, "% of the annual ET"))
```



## Region Level Analysis (North, South, West, Yolo, Central)

```{r regions_taf, echo=FALSE}

# loop through both water years 
for(y in 1:length(water_years)){
  wy <- water_years[y]
  
  p <- barchart_TAFxDeltaregions(delta_regions, wy)
  
  # add footer
  p <- p + labs(caption=footer)
  
  # add plot to rmarkdown output
  plot(p)
}

```

## ETO

```{r eto, echo=FALSE}


# add date
eto_data <- eto %>% mutate(date=date_from_wy_month(wateryear, month)) # add a date field by combining month and water year

# construct the plot object
p <- ggplot(eto_data, aes(date, mean/10, color=model, group=model)) + 
  geom_line(size=1.25)+
  #geom_line(aes(date, mean/10-stdDev/10, color=model, group=model), size=1.25, alpha=0.6, lty="dashed")+
  #geom_line(aes(date, mean/10+stdDev/10, color=model, group=model), size=1.25, alpha=0.6, lty="dashed")+
  scale_x_date(date_breaks="3 month", date_labels  = "%b")+
  coord_cartesian(ylim=c(0, 8))+
  ggtitle("ETo") +
  ylab("ETo (mm/day)") +
  geom_vline(xintercept = as.numeric(as.Date('2015-10-01')),colour="black", linetype="dashed", size=1.25, alpha=0.5)+
  annotate("text", x=as.Date('2015-04-01') , y=8, label="2015", size=5)+
  annotate("text", x=as.Date('2016-04-01') , y=8, label="2016", size=5)+
  scale_color_manual(labels=c(spatial_cimis_eto="Spatial CIMIS", disalexi_eto="DisALEXI", detaw_eto="DETAW"), values=c(spatial_cimis_eto="#619CFF", disalexi_eto="#00BA38", detaw_eto="#F8766D")) +
  theme_bw() +  # change theme simple with no axis or tick marks
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        plot.title = element_text(hjust = 0.5, size=16),
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.position="bottom", # position of legend or none
        legend.direction="horizontal", # orientation of legend
        legend.title= element_blank(), # no title for legend
        legend.key.size = unit(0.5, "cm"),
        axis.text.y=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.title.y=element_text(size=14),
        axis.line = element_line(color="black", size=1)
        )
  

p

```

