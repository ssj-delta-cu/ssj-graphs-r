---
title: "SSJ-DELTA-CU Overpass Dates"
output:
  html_document: default
---

# About
This Rmarkdown document (`figs/figures-overpass.Rmd`) is used for generating the overpass dates figures for the SSJ-Delta-CU report. The chunks can be run individually but make sure to run the `setup` and `project_settings` chunk first to ensure that all the libraries and data are loaded. 

```{r "setup", include=FALSE}
# knitr settings
require("knitr")
opts_knit$set(root.dir = "..") # set working directory to be ssj-graph-r directory
knitr::opts_chunk$set(error = TRUE)

```

```{r project_settings, echo=FALSE, include=FALSE}
# source scripts for plots and helper functions
source("scripts/helper_functions.R") # load all the helper functions
source("scripts/figures.R") # load all the functions that generate the graphs
source("scripts/tables.R") # load in the table file to calc acre-ft totals to export to csv.

# data sources
dates_grid_et <- readRDS("data/fieldstations/grid/fieldstation_grid_dates.rds")

# vector containing the water years
water_years <- c(2015, 2016)

# footer 
footer <- paste('Updated ', Sys.Date())

dates_grid_et

```


```{r exclude_outliers}
# there likey is some bad data with extreamly high/low values. Let's filter it out of the df

dates_grid_et <- dates_grid_et %>% filter(mean < 15, mean > -15)


# capitialize crop names
capFirst <- function(s) {
    paste(toupper(substring(s, 1, 1)), substring(s, 2), sep = "")
}

dates_grid_et$Crop <- capFirst(dates_grid_et$Crop)


```



```{r pairwise_plot_function, fig.width = 7, fig.height = 6}

model_x <- 'calsimetaw'
model_y <- 'disalexi'

model_pair_alldays <- function(model_x, model_y){

model_x_data <- dates_grid_et %>% filter(model==model_x)
model_y_data <- dates_grid_et %>% filter(model==model_y)

# https://stackoverflow.com/questions/7549694/adding-regression-line-equation-and-r2-on-graph
lm_eqn = function(m) {

  l <- list(a = format(coef(m)[1], digits = 2),
      b = format(abs(coef(m)[2]), digits = 2),
      r2 = format(summary(m)$r.squared, digits = 3));

  eq <- substitute(~~italic(R)^2~"="~r2,l)

  as.character(as.expression(eq));                 
}




# join using site_id and date
model_pair <- inner_join(model_x_data, model_y_data, by=c("date", "Station_ID"))

axis_limit <- max(max(model_pair$mean.y), max(model_pair$mean.x)) 

p <- ggplot(model_pair, aes(x=mean.x, y=mean.y, color=Crop.x))+geom_point(size=2.5, alpha=0.35)+
  ggtitle(paste(toupper(model_x), "vs.", toupper(model_y)))+
  ylab(paste(toupper(model_y), " ET", "\n", "(mm/day)", sep=""))+
  xlab(paste(toupper(model_x), " ET", "\n", "(mm/day)", sep=""))+
  coord_cartesian(xlim = c(0,axis_limit), ylim=c(0, axis_limit))+
  theme_bw()+
  geom_abline(intercept = 0, slope = 1, colour="black", linetype="dashed", size=2.25, alpha=0.5)+ #1:1 diagonal line
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
      plot.title = element_text(hjust = 0.5, size=16),
      panel.grid.minor = element_blank(),
      legend.position="bottom", # position of legend or none
      legend.direction="horizontal", # orientation of legend
      legend.title= element_blank(), # no title for legend
      legend.key.size = unit(0.5, "cm"),
      axis.text.y=element_text(size=14),
      axis.text.x=element_text(size=14),
      axis.title.y=element_text(size=14),
      axis.title.x=element_text(size=14),
      axis.line = element_line(color="black", size=1)
  )+ geom_smooth(method="lm", fill=NA, linetype="dashed", size=2)
p <- p + geom_text(aes(x = 0.5, y = axis_limit-1,  label = lm_eqn(lm(mean.y ~ mean.x, subset(model_pair, Crop.x=="Alfalfa")))), color="#F8766D", parse = TRUE, hjust=0)
p <- p + geom_text(aes(x = 0.5, y = axis_limit-1.5,  label = lm_eqn(lm(mean.y ~ mean.x, subset(model_pair, Crop.x=="Corn")))), color="#00BA38", parse = TRUE, hjust=0)
p <- p + geom_text(aes(x = 0.5, y = axis_limit-2,  label = lm_eqn(lm(mean.y ~ mean.x, subset(model_pair, Crop.x=="Pasture")))), color="#619CFF", parse = TRUE, hjust=0)
p
}

#model_pair_alldays(model_x, model_y)

```


```{r, echo=FALSE, fig.width = 7, fig.height = 6}

m <- methods_list()
print(m)

# create all combinations
combinations <- combn(m, 2, simplify = FALSE)

for(comb in combinations){
  #print(comb)
  x <- comb[1]
  y <- comb[2]
  print(paste(x, "vs", y))
  p <- model_pair_alldays(x, y)
  plot(p)
}

```


## Add in field measurements

```{r}
# field stations measurements
# pull in the dates csv from the ssj-field-measurements-2016 repo (assumes that there is a local copy)
# the local copy should have the same directory folder as ssj-graphs-r
list_of_csvs <- list.files(path="../ssj-field-measurements-2016/daily data", pattern="D[0-9][0-9](.*?)(.csv)", full.names=TRUE)

# for loop to load in all the raw csv files to single data frame
load_csv <- function(file_list) {
  listofdfs <- list() #Create a list in which you intend to save your df's.
  for (i in 1:length(file_list)) {
    print(file_list[i])
    g <- read.csv(file_list[i], stringsAsFactors = FALSE)
    listofdfs[[i]]<-g
  }
  df <- ldply(listofdfs, data.frame) # make into one dataframe 
}

raw_field_data <- load_csv(list_of_csvs)

# clean up station name and set model name to field
field <- raw_field_data %>% separate(stationName, into = c("Station_ID", "IslandName", "Crop"), sep='_') %>% mutate(date=as.Date(date))



dates_grid_et_w_field <- left_join(dates_grid_et, field, by=c("date", "Station_ID"))


```



```{r model_field_lm_function, fig.width = 7, fig.height = 6}


model_field_lm <- function(selected_model){

  
common_overpass_dates <- as.Date(c('2016-05-10', '2016-05-26', '2016-06-27', '2016-07-13', '2016-07-29', '2016-08-14', '2016-08-30', '2016-09-15'))

d <- dates_grid_et_w_field %>% filter(ET_SR_aH_qc_Dgf != "NA") %>% filter(model==selected_model) %>% filter(date %in% common_overpass_dates)


# https://stackoverflow.com/questions/7549694/adding-regression-line-equation-and-r2-on-graph
lm_eqn = function(m) {

  l <- list(a = format(coef(m)[1], digits = 2),
      b = format(abs(coef(m)[2]), digits = 2),
      r2 = format(summary(m)$r.squared, digits = 3));

  eq <- substitute(~~italic(R)^2~"="~r2,l)

  as.character(as.expression(eq));                 
}

axis_limit <- max(max(d$mean), max(d$ET_SR_aH_qc_Dgf)) 

p <- ggplot(d, aes(x=ET_SR_aH_qc_Dgf, y=mean, color=Crop.x))+geom_point(size=2.5, alpha=0.35)+
  ggtitle(paste(toupper(selected_model), "vs.", "Field"))+
  ylab(paste(toupper(selected_model), " ET", "\n", "(mm/day)", sep=""))+
  xlab(paste("Field ET", "\n", "(mm/day)", sep=""))+
  coord_cartesian(xlim = c(0,axis_limit), ylim=c(0, axis_limit))+
  theme_bw()+
  geom_abline(intercept = 0, slope = 1, colour="black", linetype="dashed", size=2.25, alpha=0.5)+ #1:1 diagonal line
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
      plot.title = element_text(hjust = 0.5, size=16),
      panel.grid.minor = element_blank(),
      legend.position="bottom", # position of legend or none
      legend.direction="horizontal", # orientation of legend
      legend.title= element_blank(), # no title for legend
      legend.key.size = unit(0.5, "cm"),
      axis.text.y=element_text(size=14),
      axis.text.x=element_text(size=14),
      axis.title.y=element_text(size=14),
      axis.title.x=element_text(size=14),
      axis.line = element_line(color="black", size=1)
  )+ geom_smooth(method="lm", fill=NA, linetype="dashed", size=2)
p <- p + geom_text(aes(x = 0.5, y = axis_limit-1,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(d, Crop.x=="Alfalfa")))), color="#F8766D", parse = TRUE, hjust=0)
p <- p + geom_text(aes(x = 0.5, y = axis_limit-1.5,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(d, Crop.x=="Corn")))), color="#00BA38", parse = TRUE, hjust=0)
p <- p + geom_text(aes(x = 0.5, y = axis_limit-2,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(d, Crop.x=="Pasture")))), color="#619CFF", parse = TRUE, hjust=0)
p
}



```



```{r model_field_lm_plots, echo=FALSE, fig.width = 7, fig.height = 6}

for(m in methods_list()){
  p <- model_field_lm(m)
  plot(p)
}

```


# Fieldstation vs Remote methods facet plot for Water Year 2016


```{r alfalfa, echo=FALSE, fig.width = 7, fig.height = 6}
selected_crop <- "Alfalfa"
dates_grid_et_w_field_wo_nulls <- dates_grid_et_w_field %>% filter(ET_SR_aH_qc_Dgf != "NA", Crop.x==selected_crop)

axis_limit <- max(max(dates_grid_et_w_field_wo_nulls$mean), max(dates_grid_et_w_field_wo_nulls$ET_SR_aH_qc_Dgf)) 

# https://stackoverflow.com/questions/7549694/adding-regression-line-equation-and-r2-on-graph
lm_eqn = function(m) {

  l <- list(a = format(coef(m)[1], digits = 2),
      b = format(abs(coef(m)[2]), digits = 2),
      r2 = format(summary(m)$r.squared, digits = 3));

  eq <- substitute(~~italic(R)^2~"="~r2,l)

  as.character(as.expression(eq));                 
}

p <- ggplot(dates_grid_et_w_field_wo_nulls, aes(x=ET_SR_aH_qc_Dgf, y=mean, color=model))+
  geom_point(size=1.75, alpha=0.35)+
  ggtitle(toupper(selected_crop))+
  ylab("Model ET (mm/day)")+
  xlab("Field ET (mm/day)")+
  geom_smooth(method=lm,se=FALSE, fullrange=FALSE,  size=2, alpha=0.9) + # Add linear regression line
  scale_color_manual(values=model_palette, labels=methods_named_list)+
  coord_cartesian(xlim = c(0,axis_limit), ylim=c(0, axis_limit))+
  geom_abline(intercept = 0, slope = 1, colour="black", linetype="dashed", size=2.25, alpha=0.5)+ #1:1 diagonal line
  theme_bw()+
  theme(panel.border = element_rect(colour = "black", fill="NA", size=1),
        panel.grid.major = element_blank(),
        plot.title = element_text(hjust = 0.5),
        panel.grid.minor = element_blank(),
        legend.position="bottom", # position of legend or none
        legend.direction="horizontal", # orientation of legend
        legend.title= element_blank(), # no title for legend
        legend.key.size = unit(0.5, "cm"),
        axis.text.y = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=14))+ 
  theme(strip.background = element_blank(),
        strip.placement = "outside", 
        strip.text.x = element_text(size = 16))+
  guides(colour = guide_legend(nrow = 2, keywidth = 3, keyheight = 1),
         fill = guide_legend(keywidth = 1, keyheight = 1),
        linetype=guide_legend(keywidth = 3, keyheight = 1))

p <- p + geom_text(aes(x = 0, y = axis_limit-0,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="calsimetaw")))), color="#0072b2", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-0.5,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="detaw")))), color="#d55e00", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-1,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="disalexi")))), color="#e69f00", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-1.5,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="itrc")))), color="#009e73", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-2,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="sims")))), color="#cc79a7", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-2.5,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="ucdmetric")))), color="#56b4df", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-3,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="ucdpt")))), color="#f0e442", parse = TRUE, hjust=0)


p

```


```{r corn, echo=FALSE, fig.width = 7, fig.height = 6}
selected_crop <- "Corn"
dates_grid_et_w_field_wo_nulls <- dates_grid_et_w_field %>% filter(ET_SR_aH_qc_Dgf != "NA", Crop.x==selected_crop)

axis_limit <- max(max(dates_grid_et_w_field_wo_nulls$mean), max(dates_grid_et_w_field_wo_nulls$ET_SR_aH_qc_Dgf)) 

# https://stackoverflow.com/questions/7549694/adding-regression-line-equation-and-r2-on-graph
lm_eqn = function(m) {

  l <- list(a = format(coef(m)[1], digits = 2),
      b = format(abs(coef(m)[2]), digits = 2),
      r2 = format(summary(m)$r.squared, digits = 3));

  eq <- substitute(~~italic(R)^2~"="~r2,l)

  as.character(as.expression(eq));                 
}

p <- ggplot(dates_grid_et_w_field_wo_nulls, aes(x=ET_SR_aH_qc_Dgf, y=mean, color=model))+
  geom_point(size=1.75, alpha=0.35)+
  ggtitle(toupper(selected_crop))+
  ylab("Model ET (mm/day)")+
  xlab("Field ET (mm/day)")+
  geom_smooth(method=lm,se=FALSE, fullrange=FALSE,  size=2, alpha=0.9) + # Add linear regression line
  scale_color_manual(values=model_palette, labels=methods_named_list)+
  coord_cartesian(xlim = c(0,axis_limit), ylim=c(0, axis_limit))+
  geom_abline(intercept = 0, slope = 1, colour="black", linetype="dashed", size=2.25, alpha=0.5)+ #1:1 diagonal line
  theme_bw()+
  theme(panel.border = element_rect(colour = "black", fill="NA", size=1),
        panel.grid.major = element_blank(),
        plot.title = element_text(hjust = 0.5),
        panel.grid.minor = element_blank(),
        legend.position="bottom", # position of legend or none
        legend.direction="horizontal", # orientation of legend
        legend.title= element_blank(), # no title for legend
        legend.key.size = unit(0.5, "cm"),
        axis.text.y = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=14))+ 
  theme(strip.background = element_blank(),
        strip.placement = "outside", 
        strip.text.x = element_text(size = 16))+
  guides(colour = guide_legend(nrow = 2, keywidth = 3, keyheight = 1),
         fill = guide_legend(keywidth = 1, keyheight = 1),
        linetype=guide_legend(keywidth = 3, keyheight = 1))

p <- p + geom_text(aes(x = 0, y = axis_limit-0,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="calsimetaw")))), color="#0072b2", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-0.5,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="detaw")))), color="#d55e00", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-1,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="disalexi")))), color="#e69f00", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-1.5,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="itrc")))), color="#009e73", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-2,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="sims")))), color="#cc79a7", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-2.5,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="ucdmetric")))), color="#56b4df", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-3,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="ucdpt")))), color="#f0e442", parse = TRUE, hjust=0)


p

```


```{r pasture, echo=FALSE, fig.width = 7, fig.height = 6}
selected_crop <- "Pasture"
dates_grid_et_w_field_wo_nulls <- dates_grid_et_w_field %>% filter(ET_SR_aH_qc_Dgf != "NA", Crop.x==selected_crop)

axis_limit <- max(max(dates_grid_et_w_field_wo_nulls$mean), max(dates_grid_et_w_field_wo_nulls$ET_SR_aH_qc_Dgf)) 

# https://stackoverflow.com/questions/7549694/adding-regression-line-equation-and-r2-on-graph
lm_eqn = function(m) {

  l <- list(a = format(coef(m)[1], digits = 2),
      b = format(abs(coef(m)[2]), digits = 2),
      r2 = format(summary(m)$r.squared, digits = 3));

  eq <- substitute(~~italic(R)^2~"="~r2,l)

  as.character(as.expression(eq));                 
}

p <- ggplot(dates_grid_et_w_field_wo_nulls, aes(x=ET_SR_aH_qc_Dgf, y=mean, color=model))+
  geom_point(size=1.75, alpha=0.35)+
  ggtitle(toupper(selected_crop))+
  ylab("Model ET (mm/day)")+
  xlab("Field ET (mm/day)")+
  geom_smooth(method=lm,se=FALSE, fullrange=FALSE,  size=2, alpha=0.9) + # Add linear regression line
  scale_color_manual(values=model_palette, labels=methods_named_list)+
  coord_cartesian(xlim = c(0,axis_limit), ylim=c(0, axis_limit))+
  geom_abline(intercept = 0, slope = 1, colour="black", linetype="dashed", size=2.25, alpha=0.5)+ #1:1 diagonal line
  theme_bw()+
  theme(panel.border = element_rect(colour = "black", fill="NA", size=1),
        panel.grid.major = element_blank(),
        plot.title = element_text(hjust = 0.5),
        panel.grid.minor = element_blank(),
        legend.position="bottom", # position of legend or none
        legend.direction="horizontal", # orientation of legend
        legend.title= element_blank(), # no title for legend
        legend.key.size = unit(0.5, "cm"),
        axis.text.y = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=14))+ 
  theme(strip.background = element_blank(),
        strip.placement = "outside", 
        strip.text.x = element_text(size = 16))+
  guides(colour = guide_legend(nrow = 2, keywidth = 3, keyheight = 1),
         fill = guide_legend(keywidth = 1, keyheight = 1),
        linetype=guide_legend(keywidth = 3, keyheight = 1))

p <- p + geom_text(aes(x = 0, y = axis_limit-0,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="calsimetaw")))), color="#0072b2", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-0.5,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="detaw")))), color="#d55e00", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-1,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="disalexi")))), color="#e69f00", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-1.5,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="itrc")))), color="#009e73", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-2,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="sims")))), color="#cc79a7", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-2.5,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="ucdmetric")))), color="#56b4df", parse = TRUE, hjust=0)

p <- p + geom_text(aes(x = 0, y = axis_limit-3,  label = lm_eqn(lm(mean ~ ET_SR_aH_qc_Dgf, subset(dates_grid_et_w_field_wo_nulls, model=="ucdpt")))), color="#f0e442", parse = TRUE, hjust=0)


p

```